{
  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "containerGroupName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Azure Container Instance group"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources. Defaults to the resource group's location."
      }
    },
    "cpu": {
      "type": "int",
      "defaultValue": 4,
      "metadata": {
        "description": "CPU cores for the container"
      }
    },
    "memoryInGb": {
      "type": "string",
      "defaultValue": "16",
      "metadata": {
        "description": "Memory (in GB) for the container"
      }
    },
    "port": {
      "type": "int",
      "defaultValue": 50051,
      "metadata": {
        "description": "Container and public port to expose"
      }
    },
    "dnsLabelPrefix": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Public DNS label prefix for the container group's IP (must be globally unique in region). Leave empty to omit."
      }
    },
    "registryServer": {
      "type": "string",
      "defaultValue": "ispirt.azurecr.io",
      "metadata": {
        "description": "Container registry login server"
      }
    },
    "registryUsername": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Container registry username (leave empty if using managed identity)"
      }
    },
    "registryPassword": {
      "type": "secureString",
      "defaultValue": "",
      "metadata": {
        "description": "Container registry password (leave empty if using managed identity)"
      }
    },
    "env_BFE_INGRESS_TLS": {
      "type": "string",
      "defaultValue": ""
    },
    "env_BFE_TCMALLOC_BACKGROUND_RELEASE_RATE_BYTES_PER_SECOND": {
      "type": "string",
      "defaultValue": ""
    },
    "env_BFE_TCMALLOC_MAX_TOTAL_THREAD_CACHE_BYTES": {
      "type": "string",
      "defaultValue": ""
    },
    "env_BFE_TLS_CERT": {
      "type": "string",
      "defaultValue": ""
    },
    "env_BFE_TLS_KEY": {
      "type": "string",
      "defaultValue": ""
    },
    "env_BIDDING_EGRESS_TLS": {
      "type": "string",
      "defaultValue": ""
    },
    "env_BIDDING_SERVER_ADDR": {
      "type": "string",
      "defaultValue": ""
    },
    "env_BIDDING_SIGNALS_LOAD_TIMEOUT_MS": {
      "type": "string",
      "defaultValue": ""
    },
    "env_BUYER_FRONTEND_HEALTHCHECK_PORT": {
      "type": "string",
      "defaultValue": ""
    },
    "env_BUYER_FRONTEND_PORT": {
      "type": "string",
      "defaultValue": ""
    },
    "env_BUYER_KV_SERVER_ADDR": {
      "type": "string",
      "defaultValue": ""
    },
    "env_ENABLE_TKV_V2": {
      "type": "string",
      "defaultValue": ""
    },
    "env_ENABLE_TKV_V2_BROWSER": {
      "type": "string",
      "defaultValue": ""
    },
    "env_BUYER_TKV_V2_SERVER_ADDR": {
      "type": "string",
      "defaultValue": ""
    },
    "env_TKV_EGRESS_TLS": {
      "type": "string",
      "defaultValue": ""
    },
    "env_BYOS_AD_RETRIEVAL_SERVER": {
      "type": "string",
      "defaultValue": ""
    },
    "env_CREATE_NEW_EVENT_ENGINE": {
      "type": "string",
      "defaultValue": ""
    },
    "env_ENABLE_BIDDING_COMPRESSION": {
      "type": "string",
      "defaultValue": ""
    },
    "env_ENABLE_BUYER_FRONTEND_BENCHMARKING": {
      "type": "string",
      "defaultValue": ""
    },
    "env_GENERATE_BID_TIMEOUT_MS": {
      "type": "string",
      "defaultValue": ""
    },
    "env_GRPC_ARG_DEFAULT_AUTHORITY": {
      "type": "string",
      "defaultValue": ""
    },
    "env_PROTECTED_APP_SIGNALS_GENERATE_BID_TIMEOUT_MS": {
      "type": "string",
      "defaultValue": ""
    },
    "env_AZURE_BA_PARAM_GET_TOKEN_URL": {
      "type": "string",
      "defaultValue": ""
    },
    "env_ENABLE_PROTECTED_AUDIENCE": {
      "type": "string",
      "defaultValue": ""
    },
    "env_KEY_REFRESH_FLOW_RUN_FREQUENCY_SECONDS": {
      "type": "string",
      "defaultValue": ""
    },
    "env_PRIMARY_COORDINATOR_ACCOUNT_IDENTITY": {
      "type": "string",
      "defaultValue": ""
    },
    "env_PRIMARY_COORDINATOR_REGION": {
      "type": "string",
      "defaultValue": ""
    },
    "env_PRIVATE_KEY_CACHE_TTL_SECONDS": {
      "type": "string",
      "defaultValue": ""
    },
    "env_TELEMETRY_CONFIG": {
      "type": "string",
      "defaultValue": ""
    },
    "env_COLLECTOR_ENDPOINT": {
      "type": "string",
      "defaultValue": ""
    },
    "env_BUYER_EGRESS_TLS": {
      "type": "string",
      "defaultValue": ""
    },
    "env_CONSENTED_DEBUG_TOKEN": {
      "type": "string",
      "defaultValue": ""
    },
    "env_ENABLE_AUCTION_COMPRESSION": {
      "type": "string",
      "defaultValue": ""
    },
    "env_ENABLE_BUYER_COMPRESSION": {
      "type": "string",
      "defaultValue": ""
    },
    "env_ENABLE_CHAFFING": {
      "type": "string",
      "defaultValue": ""
    },
    "env_ENABLE_OTEL_BASED_LOGGING": {
      "type": "string",
      "defaultValue": ""
    },
    "env_ENABLE_PROTECTED_APP_SIGNALS": {
      "type": "string",
      "defaultValue": ""
    },
    "env_KV_SERVER_EGRESS_TLS": {
      "type": "string",
      "defaultValue": ""
    },
    "env_MAX_ALLOWED_SIZE_DEBUG_URL_BYTES": {
      "type": "string",
      "defaultValue": ""
    },
    "env_MAX_ALLOWED_SIZE_ALL_DEBUG_URLS_KB": {
      "type": "string",
      "defaultValue": ""
    },
    "env_PS_VERBOSITY": {
      "type": "string",
      "defaultValue": ""
    },
    "env_ROMA_TIMEOUT_MS": {
      "type": "string",
      "defaultValue": ""
    },
    "env_TEE_AD_RETRIEVAL_KV_SERVER_ADDR": {
      "type": "string",
      "defaultValue": ""
    },
    "env_TEE_KV_SERVER_ADDR": {
      "type": "string",
      "defaultValue": ""
    },
    "env_AD_RETRIEVAL_KV_SERVER_ADDR": {
      "type": "string",
      "defaultValue": ""
    },
    "env_AD_RETRIEVAL_KV_SERVER_EGRESS_TLS": {
      "type": "string",
      "defaultValue": ""
    },
    "env_AD_RETRIEVAL_TIMEOUT_MS": {
      "type": "string",
      "defaultValue": ""
    },
    "env_INFERENCE_MODEL_BUCKET_NAME": {
      "type": "string",
      "defaultValue": ""
    },
    "env_INFERENCE_MODEL_BUCKET_PATHS": {
      "type": "string",
      "defaultValue": ""
    },
    "env_INFERENCE_MODEL_CONFIG_PATH": {
      "type": "string",
      "defaultValue": ""
    },
    "env_INFERENCE_MODEL_FETCH_PERIOD_MS": {
      "type": "string",
      "defaultValue": ""
    },
    "env_INFERENCE_MODEL_LOCAL_PATHS": {
      "type": "string",
      "defaultValue": ""
    },
    "env_INFERENCE_SIDECAR_BINARY_PATH": {
      "type": "string",
      "defaultValue": ""
    },
    "env_K_ANONYMITY_SERVER_ADDR": {
      "type": "string",
      "defaultValue": ""
    },
    "env_K_ANONYMITY_SERVER_TIMEOUT_MS": {
      "type": "string",
      "defaultValue": ""
    },
    "env_SELECTION_KV_SERVER_ADDR": {
      "type": "string",
      "defaultValue": ""
    },
    "env_SELECTION_KV_SERVER_EGRESS_TLS": {
      "type": "string",
      "defaultValue": ""
    },
    "env_SELECTION_KV_SERVER_TIMEOUT_MS": {
      "type": "string",
      "defaultValue": ""
    }
  },
  "variables": {},
  "resources": [
    {
      "type": "Microsoft.ContainerInstance/containerGroups",
      "apiVersion": "2023-05-01",
      "name": "[parameters('containerGroupName')]",
      "location": "[parameters('location')]",
      "properties": {
        "containers": [
          {
            "name": "[parameters('containerGroupName')]",
            "properties": {
              "image": "ispirt.azurecr.io/depa-inferencing/azure/buyer-frontend-service:nonprod-4.8.0.0",
              "resources": {
                "requests": {
                  "cpu": "[parameters('cpu')]",
                  "memoryInGB": "[json(parameters('memoryInGb'))]"
                }
              },
              "ports": [
                {
                  "port": "[parameters('port')]"
                }
              ],
              "environmentVariables": [
                {
                  "name": "BFE_INGRESS_TLS",
                  "value": "[parameters('env_BFE_INGRESS_TLS')]"
                },
                {
                  "name": "BFE_TCMALLOC_BACKGROUND_RELEASE_RATE_BYTES_PER_SECOND",
                  "value": "[parameters('env_BFE_TCMALLOC_BACKGROUND_RELEASE_RATE_BYTES_PER_SECOND')]"
                },
                {
                  "name": "BFE_TCMALLOC_MAX_TOTAL_THREAD_CACHE_BYTES",
                  "value": "[parameters('env_BFE_TCMALLOC_MAX_TOTAL_THREAD_CACHE_BYTES')]"
                },
                {
                  "name": "BFE_TLS_CERT",
                  "value": "[parameters('env_BFE_TLS_CERT')]"
                },
                {
                  "name": "BFE_TLS_KEY",
                  "value": "[parameters('env_BFE_TLS_KEY')]"
                },
                {
                  "name": "BIDDING_EGRESS_TLS",
                  "value": "[parameters('env_BIDDING_EGRESS_TLS')]"
                },
                {
                  "name": "BIDDING_SERVER_ADDR",
                  "value": "[parameters('env_BIDDING_SERVER_ADDR')]"
                },
                {
                  "name": "BIDDING_SIGNALS_LOAD_TIMEOUT_MS",
                  "value": "[parameters('env_BIDDING_SIGNALS_LOAD_TIMEOUT_MS')]"
                },
                {
                  "name": "BUYER_FRONTEND_HEALTHCHECK_PORT",
                  "value": "[parameters('env_BUYER_FRONTEND_HEALTHCHECK_PORT')]"
                },
                {
                  "name": "BUYER_FRONTEND_PORT",
                  "value": "[parameters('env_BUYER_FRONTEND_PORT')]"
                },
                {
                  "name": "BUYER_KV_SERVER_ADDR",
                  "value": "[parameters('env_BUYER_KV_SERVER_ADDR')]"
                },
                {
                  "name": "ENABLE_TKV_V2",
                  "value": "[parameters('env_ENABLE_TKV_V2')]"
                },
                {
                  "name": "ENABLE_TKV_V2_BROWSER",
                  "value": "[parameters('env_ENABLE_TKV_V2_BROWSER')]"
                },
                {
                  "name": "BUYER_TKV_V2_SERVER_ADDR",
                  "value": "[parameters('env_BUYER_TKV_V2_SERVER_ADDR')]"
                },
                {
                  "name": "TKV_EGRESS_TLS",
                  "value": "[parameters('env_TKV_EGRESS_TLS')]"
                },
                {
                  "name": "BYOS_AD_RETRIEVAL_SERVER",
                  "value": "[parameters('env_BYOS_AD_RETRIEVAL_SERVER')]"
                },
                {
                  "name": "CREATE_NEW_EVENT_ENGINE",
                  "value": "[parameters('env_CREATE_NEW_EVENT_ENGINE')]"
                },
                {
                  "name": "ENABLE_BIDDING_COMPRESSION",
                  "value": "[parameters('env_ENABLE_BIDDING_COMPRESSION')]"
                },
                {
                  "name": "ENABLE_BUYER_FRONTEND_BENCHMARKING",
                  "value": "[parameters('env_ENABLE_BUYER_FRONTEND_BENCHMARKING')]"
                },
                {
                  "name": "GENERATE_BID_TIMEOUT_MS",
                  "value": "[parameters('env_GENERATE_BID_TIMEOUT_MS')]"
                },
                {
                  "name": "GRPC_ARG_DEFAULT_AUTHORITY",
                  "value": "[parameters('env_GRPC_ARG_DEFAULT_AUTHORITY')]"
                },
                {
                  "name": "PROTECTED_APP_SIGNALS_GENERATE_BID_TIMEOUT_MS",
                  "value": "[parameters('env_PROTECTED_APP_SIGNALS_GENERATE_BID_TIMEOUT_MS')]"
                },
                {
                  "name": "AZURE_BA_PARAM_GET_TOKEN_URL",
                  "value": "[parameters('env_AZURE_BA_PARAM_GET_TOKEN_URL')]"
                },
                {
                  "name": "AZURE_BA_PARAM_KMS_UNWRAP_URL",
                  "value": "https://depa-inferencing-kms.centralindia.cloudapp.azure.com/app/unwrapKey?fmt=tink"
                },
                {
                  "name": "ENABLE_PROTECTED_AUDIENCE",
                  "value": "[parameters('env_ENABLE_PROTECTED_AUDIENCE')]"
                },
                {
                  "name": "KEY_REFRESH_FLOW_RUN_FREQUENCY_SECONDS",
                  "value": "[parameters('env_KEY_REFRESH_FLOW_RUN_FREQUENCY_SECONDS')]"
                },
                {
                  "name": "PRIMARY_COORDINATOR_ACCOUNT_IDENTITY",
                  "value": "[parameters('env_PRIMARY_COORDINATOR_ACCOUNT_IDENTITY')]"
                },
                {
                  "name": "PRIMARY_COORDINATOR_PRIVATE_KEY_ENDPOINT",
                  "value": "https://depa-inferencing-kms.centralindia.cloudapp.azure.com/app/key?fmt=tink"
                },
                {
                  "name": "PRIMARY_COORDINATOR_REGION",
                  "value": "[parameters('env_PRIMARY_COORDINATOR_REGION')]"
                },
                {
                  "name": "PRIVATE_KEY_CACHE_TTL_SECONDS",
                  "value": "[parameters('env_PRIVATE_KEY_CACHE_TTL_SECONDS')]"
                },
                {
                  "name": "PUBLIC_KEY_ENDPOINT",
                  "value": "https://depa-inferencing-kms.centralindia.cloudapp.azure.com/app/listpubkeys"
                },
                {
                  "name": "SFE_PUBLIC_KEYS_ENDPOINTS",
                  "value": "{\"AZURE\":\"https://depa-inferencing-kms.centralindia.cloudapp.azure.com/app/listpubkeys\"}"
                },
                {
                  "name": "TEST_MODE",
                  "value": "false"
                },
                {
                  "name": "TELEMETRY_CONFIG",
                  "value": "[parameters('env_TELEMETRY_CONFIG')]"
                },
                {
                  "name": "COLLECTOR_ENDPOINT",
                  "value": "[parameters('env_COLLECTOR_ENDPOINT')]"
                },
                {
                  "name": "BUYER_EGRESS_TLS",
                  "value": "[parameters('env_BUYER_EGRESS_TLS')]"
                },
                {
                  "name": "CONSENTED_DEBUG_TOKEN",
                  "value": "[parameters('env_CONSENTED_DEBUG_TOKEN')]"
                },
                {
                  "name": "ENABLE_AUCTION_COMPRESSION",
                  "value": "[parameters('env_ENABLE_AUCTION_COMPRESSION')]"
                },
                {
                  "name": "ENABLE_BUYER_COMPRESSION",
                  "value": "[parameters('env_ENABLE_BUYER_COMPRESSION')]"
                },
                {
                  "name": "ENABLE_CHAFFING",
                  "value": "[parameters('env_ENABLE_CHAFFING')]"
                },
                {
                  "name": "ENABLE_OTEL_BASED_LOGGING",
                  "value": "[parameters('env_ENABLE_OTEL_BASED_LOGGING')]"
                },
                {
                  "name": "ENABLE_PROTECTED_APP_SIGNALS",
                  "value": "[parameters('env_ENABLE_PROTECTED_APP_SIGNALS')]"
                },
                {
                  "name": "KV_SERVER_EGRESS_TLS",
                  "value": "[parameters('env_KV_SERVER_EGRESS_TLS')]"
                },
                {
                  "name": "MAX_ALLOWED_SIZE_DEBUG_URL_BYTES",
                  "value": "[parameters('env_MAX_ALLOWED_SIZE_DEBUG_URL_BYTES')]"
                },
                {
                  "name": "MAX_ALLOWED_SIZE_ALL_DEBUG_URLS_KB",
                  "value": "[parameters('env_MAX_ALLOWED_SIZE_ALL_DEBUG_URLS_KB')]"
                },
                {
                  "name": "PS_VERBOSITY",
                  "value": "[parameters('env_PS_VERBOSITY')]"
                },
                {
                  "name": "ROMA_TIMEOUT_MS",
                  "value": "[parameters('env_ROMA_TIMEOUT_MS')]"
                },
                {
                  "name": "TEE_AD_RETRIEVAL_KV_SERVER_ADDR",
                  "value": "[parameters('env_TEE_AD_RETRIEVAL_KV_SERVER_ADDR')]"
                },
                {
                  "name": "TEE_KV_SERVER_ADDR",
                  "value": "[parameters('env_TEE_KV_SERVER_ADDR')]"
                },
                {
                  "name": "AD_RETRIEVAL_KV_SERVER_ADDR",
                  "value": "[parameters('env_AD_RETRIEVAL_KV_SERVER_ADDR')]"
                },
                {
                  "name": "AD_RETRIEVAL_KV_SERVER_EGRESS_TLS",
                  "value": "[parameters('env_AD_RETRIEVAL_KV_SERVER_EGRESS_TLS')]"
                },
                {
                  "name": "AD_RETRIEVAL_TIMEOUT_MS",
                  "value": "[parameters('env_AD_RETRIEVAL_TIMEOUT_MS')]"
                },
                {
                  "name": "INFERENCE_MODEL_BUCKET_NAME",
                  "value": "[parameters('env_INFERENCE_MODEL_BUCKET_NAME')]"
                },
                {
                  "name": "INFERENCE_MODEL_BUCKET_PATHS",
                  "value": "[parameters('env_INFERENCE_MODEL_BUCKET_PATHS')]"
                },
                {
                  "name": "INFERENCE_MODEL_CONFIG_PATH",
                  "value": "[parameters('env_INFERENCE_MODEL_CONFIG_PATH')]"
                },
                {
                  "name": "INFERENCE_MODEL_FETCH_PERIOD_MS",
                  "value": "[parameters('env_INFERENCE_MODEL_FETCH_PERIOD_MS')]"
                },
                {
                  "name": "INFERENCE_MODEL_LOCAL_PATHS",
                  "value": "[parameters('env_INFERENCE_MODEL_LOCAL_PATHS')]"
                },
                {
                  "name": "INFERENCE_SIDECAR_BINARY_PATH",
                  "value": "[parameters('env_INFERENCE_SIDECAR_BINARY_PATH')]"
                },
                {
                  "name": "K_ANONYMITY_SERVER_ADDR",
                  "value": "[parameters('env_K_ANONYMITY_SERVER_ADDR')]"
                },
                {
                  "name": "K_ANONYMITY_SERVER_TIMEOUT_MS",
                  "value": "[parameters('env_K_ANONYMITY_SERVER_TIMEOUT_MS')]"
                },
                {
                  "name": "SELECTION_KV_SERVER_ADDR",
                  "value": "[parameters('env_SELECTION_KV_SERVER_ADDR')]"
                },
                {
                  "name": "SELECTION_KV_SERVER_EGRESS_TLS",
                  "value": "[parameters('env_SELECTION_KV_SERVER_EGRESS_TLS')]"
                },
                {
                  "name": "SELECTION_KV_SERVER_TIMEOUT_MS",
                  "value": "[parameters('env_SELECTION_KV_SERVER_TIMEOUT_MS')]"
                }
              ]
            }
          }
        ],
        "osType": "Linux",
        "sku": "Confidential",
        "confidentialComputeProperties": {
          "ccePolicy": "ewo="
        },
        "restartPolicy": "Always",
        "ipAddress": {
          "type": "Public",
          "ports": [
            {
              "protocol": "TCP",
              "port": "[parameters('port')]"
            }
          ],
          "dnsNameLabel": "[if(equals(parameters('dnsLabelPrefix'), ''), json('null'), parameters('dnsLabelPrefix'))]"
        }
      }
    }
  ]
}
